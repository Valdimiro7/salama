{% extends 'layouts/sl_base.html' %}
{% load static %}

{% block content %}
  <div class="container-fluid py-2">
    <div class="row">
      <div class="col-12 col-xl-11 mx-auto">
        <div class="card my-4">
          <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
            <div class="shadow-dark border-radius-lg pt-4 pb-3" style="background-color:#064E3B;">
              <h6 class="text-white text-capitalize ps-3">Contratos de Leasing · Tuk-Tuk</h6>
            </div>
          </div>

          <div class="card-body px-0 pb-2">
            <div class="p-4">
              <!-- KPI CARDS -->
              <div class="row mb-4">
                <div class="col-md-3 col-sm-6 mb-3">
                  <div class="card shadow-sm border-0 h-100">
                    <div class="card-body py-3">
                      <p class="text-sm text-muted mb-1">Total de contratos</p>
                      <h4 class="mb-0">{{ kpi_total }}</h4>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                  <div class="card shadow-sm border-0 h-100">
                    <div class="card-body py-3">
                      <p class="text-sm text-muted mb-1">Contratos activos</p>
                      <h5 class="mb-0 text-success">{{ kpi_active }}</h5>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                  <div class="card shadow-sm border-0 h-100">
                    <div class="card-body py-3">
                      <p class="text-sm text-muted mb-1">Renda semanal total (MT)</p>
                      <h5 class="mb-0">{{ kpi_weekly_sum|floatformat:2 }}</h5>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                  <div class="card shadow-sm border-0 h-100">
                    <div class="card-body py-3">
                      <p class="text-sm text-muted mb-1">Tuk-Tuk em leasing</p>
                      <h5 class="mb-0 text-primary">{{ kpi_tuktuks_in_leasing }}</h5>
                    </div>
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <h6 class="mb-0">Contratos de Leasing</h6>
                  <p class="text-sm text-muted mb-0">Lista de contratos entre Tuk-Tuk e motoristas/cliente, com rendas semanais.</p>
                </div>
                <div>
                  <button type="button" class="btn bg-gradient-dark btn-sm" id="btn-open-add-contract">
                    <i class="material-symbols-rounded me-1" style="font-size:18px;">add</i>
                    Novo Contrato
                  </button>
                </div>
              </div>

              <div class="table-responsive">
                <table id="tuktuk-contract-table" class="table table-bordered table-striped align-items-center mb-0" style="width:100%">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Tuk-Tuk</th>
                      <th>Motorista</th>
                      <th>Renda semanal (MT)</th>
                      <th>Data início</th>
                      <th>Data fim prevista</th>
                      <th>Status</th>
                      <th>Conta da empresa</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for c in contracts %}
                      <tr>
                        <td>{{ c.id }}</td>
                        <td>
                          {{ c.tuktuk.plate_number }}
                          <br />
                          <small class="text-muted">{{ c.tuktuk.model|default:'—' }}</small>
                        </td>
                        <td>
                          {{ c.driver.first_name }} {{ c.driver.last_name }}
                          <br />
                          <small class="text-muted">{{ c.driver.phone }}</small>
                        </td>
                        <td>{{ c.weekly_rent|floatformat:2 }}</td>
                        <td>{{ c.start_date }}</td>
                        <td>{{ c.end_date|default:'—' }}</td>
                        <td>
                          {% if c.status == 'active' %}
                            <span class="badge bg-success">Activo</span>
                          {% elif c.status == 'finished' %}
                            <span class="badge bg-secondary">Terminado</span>
                          {% else %}
                            <span class="badge bg-danger">Cancelado</span>
                          {% endif %}
                        </td>
                        <td>
                          {{ c.company_account.name }}
                          <br />
                          <small class="text-muted">{{ c.company_account.account_identifier }}</small>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% include 'includes/sl_footer.html' %}
  </div>

  <!-- MODAL: NOVO CONTRATO DE LEASING -->
  <div class="modal fade" id="addContractModal" tabindex="-1" aria-labelledby="addContractModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="addContractForm">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="addContractModalLabel">Novo Contrato de Leasing · Tuk-Tuk</h5>
            <button type="button" class="btn-close text-dark" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Tuk-Tuk *</label>
              <div class="input-group input-group-outline">
                <select class="form-select" name="tuktuk" id="id_tuktuk">
                  <option value="">— Seleccione —</option>
                  {% for t in available_tuktuks %}
                    <option value="{{ t.id }}" data-rent="{{ t.weekly_rent_default|floatformat:2 }}">{{ t.plate_number }} · {{ t.model|default:'' }}</option>
                  {% endfor %}
                </select>
              </div>
              <small class="text-muted" id="tuktuk-rent-hint"></small>
            </div>

            <div class="mb-3">
              <label class="form-label">Motorista *</label>
              <div class="input-group input-group-outline">
                <select class="form-select" name="driver" id="id_driver">
                  <option value="">— Seleccione —</option>
                  {% for d in drivers %}
                    <option value="{{ d.id }}">{{ d.first_name }} {{ d.last_name }} · {{ d.phone }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Conta da Empresa *</label>
              <div class="input-group input-group-outline">
                <select class="form-select" name="company_account" id="id_company_account">
                  <option value="">— Seleccione —</option>
                  {% for ca in company_accounts %}
                    <option value="{{ ca.id }}">{{ ca.name }} - {{ ca.account_identifier }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Data de início *</label>
              <div class="input-group input-group-outline">
                <input type="date" class="form-control" name="start_date" id="id_start_date" value="{{ now|date:'Y-m-d' }}" />
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Data de fim (opcional)</label>
              <div class="input-group input-group-outline">
                <input type="date" class="form-control" name="end_date" id="id_end_date" />
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Renda semanal (MT) *</label>
              <div class="input-group input-group-outline">
                <input type="number" step="0.01" class="form-control" name="weekly_rent" id="id_weekly_rent" />
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Dia de pagamento (opcional)</label>
              <div class="input-group input-group-outline">
                <select class="form-select" name="payment_weekday" id="id_payment_weekday">
                  <option value="">— Não definido —</option>
                  <option value="1">Segunda-feira</option>
                  <option value="2">Terça-feira</option>
                  <option value="3">Quarta-feira</option>
                  <option value="4">Quinta-feira</option>
                  <option value="5">Sexta-feira</option>
                  <option value="6">Sábado</option>
                  <option value="7">Domingo</option>
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Notas (opcional)</label>
              <div class="input-group input-group-outline">
                <textarea class="form-control" rows="2" name="notes" id="id_notes"></textarea>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn bg-gradient-dark">Criar Contrato</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <!-- DataTables + Buttons + SweetAlert -->
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      $('#tuktuk-contract-table').DataTable({
        pageLength: 25,
        lengthMenu: [
          [10, 25, 50, -1],
          [10, 25, 50, 'Todos']
        ],
        order: [[0, 'desc']],
        dom: 'lBfrtip',
        buttons: [
          { extend: 'copy', text: 'Copiar', className: 'btn btn-sm btn-outline-secondary' },
          { extend: 'csv', text: 'CSV', className: 'btn btn-sm btn-outline-primary' },
          { extend: 'excel', text: 'Excel', className: 'btn btn-sm btn-outline-success' },
          { extend: 'pdf', text: 'PDF', className: 'btn btn-sm btn-outline-danger' },
          { extend: 'print', text: 'Imprimir', className: 'btn btn-sm btn-outline-dark' }
        ],
        language: {
          url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/pt-PT.json'
        }
      })
    
      const contractModalEl = document.getElementById('addContractModal')
      const contractModal = new bootstrap.Modal(contractModalEl)
    
      // abrir modal
      document.getElementById('btn-open-add-contract').addEventListener('click', function () {
        document.getElementById('addContractForm').reset()
        document.getElementById('tuktuk-rent-hint').innerText = ''
        // data default hoje
        const todayStr = "{{ now|date:'Y-m-d'|default:None }}"
        if (todayStr) {
          document.getElementById('id_start_date').value = todayStr
        }
        contractModal.show()
      })
    
      // quando escolhe Tuk-Tuk, mostrar renda padrão e preencher campo se vazio
      $('#id_tuktuk').on('change', function () {
        const opt = this.selectedOptions[0]
        if (!opt) {
          $('#tuktuk-rent-hint').text('')
          return
        }
        const rent = opt.getAttribute('data-rent')
        if (rent) {
          $('#tuktuk-rent-hint').text('Renda semanal padrão deste Tuk-Tuk: MT ' + rent)
          const rentInput = document.getElementById('id_weekly_rent')
          if (rentInput.value === '') {
            rentInput.value = rent
          }
        } else {
          $('#tuktuk-rent-hint').text('')
        }
      })
    
      // submit form via AJAX
      $('#addContractForm').on('submit', function (e) {
        e.preventDefault()
    
        const tuktuk = $('#id_tuktuk').val()
        const driver = $('#id_driver').val()
        const companyAcc = $('#id_company_account').val()
        const startDate = $('#id_start_date').val()
        const weeklyRent = $('#id_weekly_rent').val().trim()
    
        if (!tuktuk || !driver || !companyAcc || !startDate || !weeklyRent) {
          Swal.fire('Validação', 'Preencha todos os campos obrigatórios.', 'warning')
          return
        }
    
        const formData = $(this).serialize()
    
        $.ajax({
          url: "{% url 'core:create_tuktuk_lease_contract' %}",
          type: 'POST',
          data: formData,
          headers: { 'X-CSRFToken': '{{ csrf_token }}' },
          success: function (resp) {
            if (resp.success) {
              contractModal.hide()
              Swal.fire({
                icon: 'success',
                title: 'Contrato criado',
                text: resp.message,
                timer: 2200,
                showConfirmButton: false
              }).then(() => window.location.reload())
            } else {
              Swal.fire('Erro', resp.message || 'Falha ao criar contrato.', 'error')
            }
          },
          error: function (xhr) {
            Swal.fire('Erro', xhr.responseJSON?.message || 'Falha ao criar contrato.', 'error')
          }
        })
      })
    })
  </script>
{% endblock %}
