{% extends "layouts/sl_base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid py-2">
  <div class="row">
    <div class="col-12 col-xl-11 mx-auto">

      <style>
        .kpi-card-slim {
          border-radius: 0.75rem;
          border: none;
          box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .kpi-label {
          font-size: 0.78rem;
          text-transform: uppercase;
          letter-spacing: .04em;
          color: #9e9e9e;
        }
        .kpi-value-lg {
          font-size: 1.4rem;
          font-weight: 700;
        }
        .status-pill {
          border-radius: 999px;
          padding: 4px 10px;
          font-size: 0.75rem;
          font-weight: 600;
        }
        .status-pending {
          background-color: #fff3cd;
          color: #856404;
        }
        .status-approved {
          background-color: #e3f2fd;
          color: #0d47a1;
        }
        .status-disbursed {
          background-color: #e8f5e9;
          color: #1b5e20;
        }
        .status-closed {
          background-color: #eceff1;
          color: #37474f;
        }
        .status-cancelled {
          background-color: #ffebee;
          color: #b71c1c;
        }

        .loan-filter-pills .btn {
          border-radius: 999px !important;
        }
        .loan-filter-pills .btn.active {
          background-color: #082939;
          color: #fff;
        }

        /* cursor pointer nas linhas */
        #all-loans-table tbody tr {
          cursor: pointer;
        }
      </style>

      <div class="card my-4">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
          <div class="shadow-dark border-radius-lg pt-4 pb-3" style="background-color:#082939;">
            <h6 class="text-white text-capitalize ps-3">Carteira de Empréstimos · Visão Global</h6>
          </div>
        </div>

        <div class="card-body px-0 pb-2">
          <div class="p-4">

            <!-- KPI CARDS -->
            <div class="row g-3 mb-4">
              <div class="col-md-3 col-sm-6">
                <div class="card kpi-card-slim h-100">
                  <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <div class="kpi-label mb-1">Total de empréstimos</div>
                        <div class="kpi-value-lg">{{ kpi_total_loans }}</div>
                      </div>
                      <span class="material-symbols-rounded text-secondary">
                        account_balance
                      </span>
                    </div>
                    <div class="mt-2 text-xs text-muted">
                      Inclui pendentes, aprovados, desembolsados, fechados e cancelados.
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-3 col-sm-6">
                <div class="card kpi-card-slim h-100">
                  <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <div class="kpi-label mb-1">Principal total (MT)</div>
                        <div class="kpi-value-lg">
                          {{ kpi_total_principal|floatformat:2 }}
                        </div>
                      </div>
                      <span class="material-symbols-rounded text-success">
                        payments
                      </span>
                    </div>
                    <div class="mt-2 text-xs text-muted">
                      Soma de todos os montantes concedidos.
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-3 col-sm-6">
                <div class="card kpi-card-slim h-100">
                  <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <div class="kpi-label mb-1">Total a reembolsar (MT)</div>
                        <div class="kpi-value-lg">
                          {{ kpi_total_to_repay|floatformat:2 }}
                        </div>
                      </div>
                      <span class="material-symbols-rounded text-warning">
                        trending_up
                      </span>
                    </div>
                    <div class="mt-2 text-xs text-muted">
                      Principal + juros de todos os contratos.
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-3 col-sm-6">
                <div class="card kpi-card-slim h-100">
                  <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <div class="kpi-label mb-1">Juros totais (MT)</div>
                        <div class="kpi-value-lg">
                          {{ kpi_total_interest|floatformat:2 }}
                        </div>
                      </div>
                      <span class="material-symbols-rounded text-danger">
                        percent
                      </span>
                    </div>
                    <div class="mt-2 text-xs text-muted">
                      Juros estimados a receber em toda a carteira.
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- FILTER PILLS -->
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
              <div>
                <h6 class="mb-0">Lista de todos os empréstimos</h6>
                <p class="text-sm text-muted mb-0">
                  Use os filtros rápidos para ver apenas pendentes, aprovados, desembolsados, fechados ou cancelados.
                </p>
              </div>
              <div class="loan-filter-pills btn-group btn-group-sm" role="group" aria-label="Filtro de status">
                <button type="button" class="btn btn-outline-secondary loan-status-filter active" data-status="all">
                  Todos ({{ kpi_total_loans }})
                </button>
                <button type="button" class="btn btn-outline-secondary loan-status-filter" data-status="pending">
                  Pendentes ({{ kpi_status_pending }})
                </button>
                <button type="button" class="btn btn-outline-secondary loan-status-filter" data-status="approved">
                  Aprovados ({{ kpi_status_approved }})
                </button>
                <button type="button" class="btn btn-outline-secondary loan-status-filter" data-status="disbursed">
                  Desembolsados ({{ kpi_status_disbursed }})
                </button>
                <button type="button" class="btn btn-outline-secondary loan-status-filter" data-status="closed">
                  Fechados ({{ kpi_status_closed }})
                </button>
                <button type="button" class="btn btn-outline-secondary loan-status-filter" data-status="cancelled">
                  Cancelados ({{ kpi_status_cancelled }})
                </button>
              </div>
            </div>

            <!-- TABELA -->
            <div class="table-responsive">
              <table id="all-loans-table"
                     class="table table-bordered table-striped align-items-center mb-0"
                     style="width:100%">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Data Criação</th>
                    <th>Membro</th>
                    <th>Tipo</th>
                    <th>Principal (MT)</th>
                    <th>Total a Reembolsar (MT)</th>
                    <th>Status</th>
                    <th>Prazo</th>
                    <th>Data Início</th>
                    <th>1ª Prestação</th>
                    <th>Aprovado por</th>
                    <th>Data Desembolso</th>
                    <!-- Coluna oculta com o código do status -->
                    <th>StatusCode</th>
                  </tr>
                </thead>
                <tbody>
                  {% for loan in loans %}
                    <tr data-loan-id="{{ loan.id }}">
                      <!-- ID -->
                      <td>{{ loan.id }}</td>

                      <!-- Data criação -->
                      <td>{{ loan.created_at }}</td>

                      <!-- Membro -->
                      <td>
                        {{ loan.member.first_name }} {{ loan.member.last_name }}
                        <br>
                        <small class="text-muted">
                          {{ loan.member.phone }}{% if loan.member.city %} · {{ loan.member.city }}{% endif %}
                        </small>
                      </td>

                      <!-- Tipo de empréstimo -->
                      <td>{{ loan.loan_type.name|default:"—" }}</td>

                      <!-- Principal -->
                      <td>{{ loan.principal_amount|floatformat:2 }}</td>

                      <!-- Total a Reembolsar -->
                      <td>
                        {% if loan.total_to_repay %}
                          {{ loan.total_to_repay|floatformat:2 }}
                        {% else %}
                          —
                        {% endif %}
                      </td>

                      <!-- Status (bonito) -->
                      <td>
                        {% if loan.status == "pending" %}
                          <span class="status-pill status-pending">Pendente</span>
                        {% elif loan.status == "approved" %}
                          <span class="status-pill status-approved">Aprovado</span>
                        {% elif loan.status == "disbursed" %}
                          <span class="status-pill status-disbursed">Desembolsado</span>
                        {% elif loan.status == "closed" %}
                          <span class="status-pill status-closed">Fechado</span>
                        {% elif loan.status == "cancelled" %}
                          <span class="status-pill status-cancelled">Cancelado</span>
                        {% else %}
                          <span class="badge bg-secondary">—</span>
                        {% endif %}
                      </td>

                      <!-- Prazo -->
                      <td>
                        {{ loan.term_periods }}
                        {% if loan.period_type == "monthly" %}
                          meses
                        {% elif loan.period_type == "daily" %}
                          dias
                        {% else %}
                          períodos
                        {% endif %}
                      </td>

                      <!-- Data Início -->
                      <td>
                        {% if loan.release_date %}
                          {{ loan.release_date }}
                        {% else %}
                          —
                        {% endif %}
                      </td>

                      <!-- 1ª Prestação -->
                      <td>
                        {% if loan.first_payment_date %}
                          {{ loan.first_payment_date }}
                        {% else %}
                          —
                        {% endif %}
                      </td>

                      <!-- Aprovado por -->
                      <td>
                        {% if loan.approved_by %}
                          {{ loan.approved_by.get_full_name|default:loan.approved_by.username }}
                        {% else %}
                          —
                        {% endif %}
                      </td>

                      <!-- Data Desembolso -->
                      <td>
                        {% if loan.disbursed_date %}
                          {{ loan.disbursed_date }}
                          <br>
                          {% if loan.disbursed_amount %}
                            <small class="text-muted">
                              MT {{ loan.disbursed_amount|floatformat:2 }}
                            </small>
                          {% endif %}
                        {% else %}
                          —
                        {% endif %}
                      </td>

                      <!-- StatusCode (oculto, para filtragem) -->
                      <td>{{ loan.status }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

          </div>
        </div>

      </div>

    </div>
  </div>

  {% include "includes/sl_footer.html" %}
</div>

<!-- MODAL DETALHES DO EMPRÉSTIMO -->
<div class="modal fade" id="loanDetailsModal" tabindex="-1" aria-labelledby="loanDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h5 class="modal-title" id="loanDetailsModalLabel">Detalhes do Empréstimo</h5>
          <small class="text-muted" id="loanDetailsSubtitle"></small>
        </div>
        <button type="button" class="btn-close text-dark" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <!-- Nav tabs -->
        <ul class="nav nav-tabs mb-3" id="loanDetailsTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab"
                    data-bs-target="#overview-pane" type="button" role="tab">
              Overview
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="member-tab" data-bs-toggle="tab"
                    data-bs-target="#member-pane" type="button" role="tab">
              Cliente & Contas
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="disbursement-tab" data-bs-toggle="tab"
                    data-bs-target="#disbursement-pane" type="button" role="tab">
              Desembolso
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="guarantors-tab" data-bs-toggle="tab"
                    data-bs-target="#guarantors-pane" type="button" role="tab">
              Fiadores
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="guarantees-tab" data-bs-toggle="tab"
                    data-bs-target="#guarantees-pane" type="button" role="tab">
              Garantias
            </button>
          </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">
          <div class="tab-pane fade show active" id="overview-pane" role="tabpanel" aria-labelledby="overview-tab">
            <div id="overview-content">
              <p class="text-muted">A carregar detalhes do empréstimo...</p>
            </div>
          </div>

          <div class="tab-pane fade" id="member-pane" role="tabpanel" aria-labelledby="member-tab">
            <div id="member-content">
              <p class="text-muted">A carregar dados do cliente...</p>
            </div>
          </div>

          <div class="tab-pane fade" id="disbursement-pane" role="tabpanel" aria-labelledby="disbursement-tab">
            <div id="disbursement-content">
              <p class="text-muted">A carregar dados do desembolso...</p>
            </div>
          </div>

          <div class="tab-pane fade" id="guarantors-pane" role="tabpanel" aria-labelledby="guarantors-tab">
            <div id="guarantors-content">
              <p class="text-muted">A carregar fiadores...</p>
            </div>
          </div>

          <div class="tab-pane fade" id="guarantees-pane" role="tabpanel" aria-labelledby="guarantees-tab">
            <div id="guarantees-content">
              <p class="text-muted">A carregar garantias...</p>
            </div>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
  <!-- DataTables + Buttons -->
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const table = $('#all-loans-table').DataTable({
        pageLength: 25,
        lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Todos"]],
        order: [[1, 'desc'], [0, 'desc']],  // ordena por data criação e depois ID
        dom: 'lBfrtip',
        buttons: [
          { extend: 'copy',  text: 'Copiar',   className: 'btn btn-sm btn-outline-secondary' },
          { extend: 'csv',   text: 'CSV',      className: 'btn btn-sm btn-outline-primary' },
          { extend: 'excel', text: 'Excel',    className: 'btn btn-sm btn-outline-success' },
          { extend: 'pdf',   text: 'PDF',      className: 'btn btn-sm btn-outline-danger' },
          { extend: 'print', text: 'Imprimir', className: 'btn btn-sm btn-outline-dark' }
        ],
        language: {
          url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/pt-PT.json"
        },
        // esconder a coluna StatusCode (última)
        columnDefs: [
          {
            targets: 12,    // índice da coluna StatusCode
            visible: false,
            searchable: true
          }
        ]
      });

      // Filtro pelos pills
      $('.loan-status-filter').on('click', function () {
        const status = $(this).data('status'); // all / pending / approved / ...

        $('.loan-status-filter').removeClass('active');
        $(this).addClass('active');

        if (status === 'all') {
          table.column(12).search('').draw();
        } else {
          // procura exacto pelo código do status
          table.column(12).search('^' + status + '$', true, false).draw();
        }
      });

      // Clique em qualquer linha -> abrir modal com detalhes (mesmo esquema de Empréstimos Activos)
      $('#all-loans-table tbody').on('click', 'tr', function () {
        const loanId = $(this).data('loan-id');
        if (!loanId) return;

        // limpar conteúdos
        $('#loanDetailsModalLabel').text('Detalhes do Empréstimo #' + loanId);
        $('#loanDetailsSubtitle').text('');
        $('#overview-content').html('<p class="text-muted">A carregar detalhes do empréstimo...</p>');
        $('#member-content').html('<p class="text-muted">A carregar dados do cliente...</p>');
        $('#disbursement-content').html('<p class="text-muted">A carregar dados do desembolso...</p>');
        $('#guarantors-content').html('<p class="text-muted">A carregar fiadores...</p>');
        $('#guarantees-content').html('<p class="text-muted">A carregar garantias...</p>');

        const modalEl = document.getElementById('loanDetailsModal');
        const bsModal = new bootstrap.Modal(modalEl);
        bsModal.show();

        // pedir detalhes via AJAX (mesmo endpoint que já tens para activos)
        $.ajax({
          url: "{% url 'core:loan_details_any_status' 0 %}".replace('/0/', '/' + loanId + '/'),
          type: "GET",
          success: function (data) {
            if (!data || !data.loan) {
              $('#overview-content').html('<p class="text-danger">Não foi possível carregar os detalhes.</p>');
              return;
            }

            const loan = data.loan;
            const member = data.member;
            const disb = data.disbursement;
            const clientAccounts = data.client_accounts || [];
            const guarantors = data.guarantors || [];
            const guarantees = data.guarantees || [];

            // Subtitle
            $('#loanDetailsSubtitle').text(
              (member && member.name ? member.name : '') + ' · Empréstimo #' + loan.id
            );

            // Helpers safe (para evitar erros se for null)
            const fmtMoney = (v) => (v != null ? v.toFixed(2) : '—');

            // Overview
            let overviewHtml = `
              <div class="row">
                <div class="col-md-6">
                  <h6 class="mb-2">Resumo do empréstimo</h6>
                  <ul class="list-unstyled mb-3">
                    <li><strong>Tipo:</strong> ${loan.loan_type || '—'}</li>
                    <li><strong>Tipo de juro:</strong> ${loan.interest_type || '—'}</li>
                    <li><strong>Principal:</strong> MT ${fmtMoney(loan.principal_amount)}</li>
                    <li><strong>Juros:</strong> MT ${loan.total_interest != null ? fmtMoney(loan.total_interest) : '—'}</li>
                    <li><strong>Total a reembolsar:</strong> MT ${loan.total_to_repay != null ? fmtMoney(loan.total_to_repay) : '—'}</li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6 class="mb-2">Termos</h6>
                  <ul class="list-unstyled mb-3">
                    <li><strong>Período:</strong> ${loan.term_periods || '—'} ${loan.period_type || ''}</li>
                    <li><strong>Prestação por período:</strong> MT ${loan.payment_per_period != null ? fmtMoney(loan.payment_per_period) : '—'}</li>
                    <li><strong>Data início:</strong> ${loan.release_date || '—'}</li>
                    <li><strong>1ª prestação:</strong> ${loan.first_payment_date || '—'}</li>
                    <li><strong>Método de desembolso:</strong> ${loan.disburse_method || '—'}</li>
                  </ul>
                </div>
              </div>
              <div class="row mt-2">
                <div class="col-md-6">
                  <h6 class="mb-2">Workflow</h6>
                  <ul class="list-unstyled mb-0">
                    <li><strong>Criado por:</strong> ${loan.created_by || '—'}</li>
                    <li><strong>Aprovado por:</strong> ${loan.approved_by || '—'}</li>
                    <li><strong>Criado em:</strong> ${loan.created_at || '—'}</li>
                    <li><strong>Status actual:</strong> ${loan.status}</li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6 class="mb-2">Notas & Objectivo</h6>
                  <p><strong>Objectivo:</strong><br>${loan.purpose || '—'}</p>
                  <p><strong>Observações:</strong><br>${loan.remarks || '—'}</p>
                </div>
              </div>
            `;
            $('#overview-content').html(overviewHtml);

            // Member & Contas
            let memberHtml = `
              <div class="row">
                <div class="col-md-6">
                  <h6 class="mb-2">Dados do cliente</h6>
                  <ul class="list-unstyled mb-3">
                    <li><strong>Nome:</strong> ${(member && member.name) || '—'}</li>
                    <li><strong>Telefone:</strong> ${(member && member.phone) || '—'}</li>
                    <li><strong>Telefone alternativo:</strong> ${(member && member.alt_phone) || '—'}</li>
                    <li><strong>Email:</strong> ${(member && member.email) || '—'}</li>
                    <li><strong>Cidade:</strong> ${(member && member.city) || '—'}</li>
                    <li><strong>Endereço:</strong> ${(member && member.address) || '—'}</li>
                    <li><strong>Profissão:</strong> ${(member && member.profession) || '—'}</li>
                    <li><strong>Gestor de conta:</strong> ${(member && member.manager) || '—'}</li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6 class="mb-2">Contas do cliente</h6>
            `;

            if (clientAccounts.length === 0) {
              memberHtml += `<p class="text-muted">Nenhuma conta activa registada para este cliente.</p>`;
            } else {
              memberHtml += `
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Tipo</th>
                        <th>Nome</th>
                        <th>Número</th>
                        <th>Saldo (MT)</th>
                      </tr>
                    </thead>
                    <tbody>
              `;
              clientAccounts.forEach(function (ca) {
                memberHtml += `
                  <tr>
                    <td>${ca.account_type || '—'}</td>
                    <td>${ca.account_type_name || '—'}</td>
                    <td>${ca.identifier || '—'}</td>
                    <td>${ca.balance != null ? fmtMoney(ca.balance) : '—'}</td>
                  </tr>
                `;
              });
              memberHtml += `
                    </tbody>
                  </table>
                </div>
              `;
            }

            memberHtml += `
                </div>
              </div>
            `;
            $('#member-content').html(memberHtml);

            // Desembolso
            let disbHtml = `
              <h6 class="mb-3">Dados do último desembolso</h6>
            `;
            if (!disb || !disb.exists) {
              disbHtml += `<p class="text-muted">Nenhum desembolso registado.</p>`;
            } else {
              disbHtml += `
                <ul class="list-unstyled mb-3">
                  <li><strong>Valor desembolsado:</strong> MT ${disb.amount != null ? fmtMoney(disb.amount) : '—'}</li>
                  <li><strong>Data:</strong> ${disb.date || '—'}</li>
                  <li><strong>Método:</strong> ${disb.method || '—'}</li>
                  <li><strong>Conta da empresa:</strong> ${disb.company_account || '—'}</li>
                  <li><strong>Nº conta da empresa:</strong> ${disb.company_account_identifier || '—'}</li>
                  <li><strong>Notas:</strong><br>${disb.notes || '—'}</li>
                </ul>
              `;
              if (disb.attachment_url) {
                disbHtml += `
                  <p>
                    <a href="${disb.attachment_url}" target="_blank" class="btn btn-sm btn-outline-primary">
                      Ver comprovativo
                    </a>
                  </p>
                `;
              }
            }
            $('#disbursement-content').html(disbHtml);

            // Fiadores
            let guarantorsHtml = `<h6 class="mb-3">Fiadores</h6>`;
            if (guarantors.length === 0) {
              guarantorsHtml += `<p class="text-muted">Nenhum fiador registado para este empréstimo.</p>`;
            } else {
              guarantorsHtml += `
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Nome</th>
                        <th>Telefone</th>
                        <th>Nº Conta / Ref.</th>
                        <th>Montante (MT)</th>
                      </tr>
                    </thead>
                    <tbody>
              `;
              guarantors.forEach(function (g) {
                guarantorsHtml += `
                  <tr>
                    <td>${g.name || '—'}</td>
                    <td>${g.phone || '—'}</td>
                    <td>${g.account_number || '—'}</td>
                    <td>${g.amount != null ? fmtMoney(g.amount) : '—'}</td>
                  </tr>
                `;
              });
              guarantorsHtml += `
                    </tbody>
                  </table>
                </div>
              `;
            }
            $('#guarantors-content').html(guarantorsHtml);

            // Garantias
            let guaranteesHtml = `<h6 class="mb-3">Garantias</h6>`;
            if (guarantees.length === 0) {
              guaranteesHtml += `<p class="text-muted">Nenhuma garantia registada para este empréstimo.</p>`;
            } else {
              guaranteesHtml += `
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Nome</th>
                        <th>Tipo</th>
                        <th>Serial</th>
                        <th>Preço estimado (MT)</th>
                        <th>Descrição</th>
                        <th>Anexo</th>
                      </tr>
                    </thead>
                    <tbody>
              `;
              guarantees.forEach(function (gg) {
                guaranteesHtml += `
                  <tr>
                    <td>${gg.name || '—'}</td>
                    <td>${gg.guarantee_type || '—'}</td>
                    <td>${gg.serial_number || '—'}</td>
                    <td>${gg.estimated_price != null ? fmtMoney(gg.estimated_price) : '—'}</td>
                    <td>${gg.description || '—'}</td>
                    <td>
                      ${gg.attachment_url
                        ? `<a href="${gg.attachment_url}" target="_blank" class="btn btn-xs btn-outline-primary">Ver</a>`
                        : '—'}
                    </td>
                  </tr>
                `;
              });
              guaranteesHtml += `
                    </tbody>
                  </table>
                </div>
              `;
            }
            $('#guarantees-content').html(guaranteesHtml);

          },
          error: function () {
            $('#overview-content').html('<p class="text-danger">Erro ao carregar detalhes do empréstimo.</p>');
          }
        });
      });
    });
  </script>
{% endblock extra_js %}
