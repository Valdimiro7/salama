{% extends 'layouts/sl_base.html' %}
{% load static %}

{% block content %}
  <div class="container-fluid py-2">
    <div class="row">
      <div class="col-12 col-xl-11 mx-auto">
        <div class="card my-4">
          <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
            <div class="shadow-dark border-radius-lg pt-4 pb-3" style="background-color:#064E3B;">
              <h6 class="text-white text-capitalize ps-3">Reembolsos de Empréstimos</h6>
            </div>
          </div>

          <div class="card-body px-0 pb-2">
            <div class="p-4">
              <!-- KPI CARDS -->
              <div class="row mb-4">
                <div class="col-md-3 col-sm-6 mb-3">
                  <div class="card shadow-sm border-0 h-100">
                    <div class="card-body py-3">
                      <p class="text-sm text-muted mb-1">Empréstimos activos (disbursed)</p>
                      <h4 class="mb-0">{{ kpi_total_loans }}</h4>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                  <div class="card shadow-sm border-0 h-100">
                    <div class="card-body py-3">
                      <p class="text-sm text-muted mb-1">Principal total (MT)</p>
                      <h5 class="mb-0">{{ kpi_total_principal|floatformat:2 }}</h5>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                  <div class="card shadow-sm border-0 h-100">
                    <div class="card-body py-3">
                      <p class="text-sm text-muted mb-1">Saldo em dívida total (principal + juros em falta)</p>
                      <h5 class="mb-0">{{ kpi_total_outstanding|floatformat:2 }}</h5>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                  <div class="card shadow-sm border-0 h-100">
                    <div class="card-body py-3">
                      <p class="text-sm text-muted mb-1">Saldo médio em dívida (MT)</p>
                      <h5 class="mb-0">{{ kpi_avg_outstanding|floatformat:2 }}</h5>
                    </div>
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <h6 class="mb-0">Empréstimos com saldo em dívida</h6>
                  <p class="text-sm text-muted mb-0">Saldo em dívida = principal em aberto + juros em falta no ciclo actual. Validade indica o fim do ciclo de 30 dias.</p>
                </div>
              </div>

              <div class="table-responsive">
                <table id="loan-repayment-table" class="table table-bordered table-striped align-items-center mb-0" style="width:100%">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Membro</th>
                      <th>Tipo</th>
                      <th>Taxa de Juro</th>
                      <th>Principal (MT)</th>
                      <th>Principal em dívida (MT)</th>
                      <th>Juros em falta (MT)</th>
                      <th>Saldo em dívida (MT)</th>
                      <th>Validade</th>
                      <th>Último pagamento</th>
                      <th style="width: 180px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for loan in loans %}
                      <tr data-loan-id="{{ loan.id }}" data-outstanding="{{ loan.outstanding_principal|floatformat:2 }}" data-interest-remaining="{{ loan.period_interest_remaining|floatformat:2 }}" data-interest-rate="{{ loan.interest_type.rate|default_if_none:'0.0000' }}" data-cycle-due="{{ loan.current_cycle_due|default_if_none:'' }}" data-member-name="{{ loan.member.first_name }} {{ loan.member.last_name }}">
                        <td>{{ loan.id }}</td>
                        <td>
                          {{ loan.member.first_name }} {{ loan.member.last_name }}
                          <br />
                          <small class="text-muted">
                            {{ loan.member.phone }}{% if loan.member.city %}
                              · {{ loan.member.city }}
                            {% endif %}
                          </small>
                        </td>
                        <td>{{ loan.loan_type.name|default:'—' }}</td>
                        <td>
                          {% if loan.interest_type %}
                            {{ loan.interest_type.rate|floatformat:2 }}% / {{ loan.interest_type.get_period_type_display }}
                          {% else %}
                            —
                          {% endif %}
                        </td>
                        <td>{{ loan.principal_amount|floatformat:2 }}</td>
                        <td>{{ loan.outstanding_principal|floatformat:2 }}</td>
                        <td>{{ loan.period_interest_remaining|floatformat:2 }}</td>
                        <td>
                          {% if loan.outstanding_with_interest > 0 %}
                            <span class="badge bg-danger">{{ loan.outstanding_with_interest|floatformat:2 }}</span>
                          {% else %}
                            <span class="badge bg-success">0.00</span>
                          {% endif %}
                        </td>
                        <td>
                          {% if loan.current_cycle_due %}
                            {{ loan.current_cycle_due }}
                            {% if loan.current_cycle_due < today %}
                              <br /><span class="badge bg-danger mt-1">Vencido</span>
                            {% endif %}
                          {% else %}
                            —
                          {% endif %}
                        </td>
                        <td>
                          {% if loan.last_repayment %}
                            {{ loan.last_repayment.payment_date }}<br />
                            <small class="text-muted">
                              MT {{ loan.last_repayment.amount|floatformat:2 }}
                              (J: {{ loan.last_repayment.interest_amount|floatformat:0 }}
                              · P: {{ loan.last_repayment.principal_amount|floatformat:0 }})
                            </small>
                          {% else %}
                            <span class="text-muted">Sem pagamentos</span>
                          {% endif %}
                        </td>
                        <td>
                          {% if loan.outstanding_with_interest > 0 %}
                            <button type="button" class="btn btn-outline-success btn-xs btn-open-repayment-modal">
                              <i class="material-symbols-rounded" style="font-size:16px;">payments</i>
                              Registar Reembolso
                            </button>
                          {% else %}
                            <button type="button" class="btn btn-outline-secondary btn-xs" disabled>Sem dívida</button>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% include 'includes/sl_footer.html' %}
  </div>

  <!-- MODAL: REGISTAR REEMBOLSO -->
  <div class="modal fade" id="repaymentModal" tabindex="-1" aria-labelledby="repaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="repaymentForm" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="loan_id" id="id_rep_loan_id" />
          <div class="modal-header">
            <div>
              <h5 class="modal-title" id="repaymentModalLabel">Registar Reembolso</h5>
              <small class="text-muted" id="repaymentModalSubtitle"></small>
            </div>
            <button type="button" class="btn-close text-dark" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info py-2 px-3 mb-3" id="repaymentInfoBox" style="font-size: 0.85rem;">A calcular informações deste empréstimo...</div>

            <!-- TIPO DE REEMBOLSO -->
            <div class="mb-3">
              <label class="form-label d-block">Tipo de reembolso *</label>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="repayment_type" id="rep_type_interest_only" value="interest_only" />
                <label class="form-check-label" for="rep_type_interest_only">Liquidar apenas juros</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="repayment_type" id="rep_type_full" value="full" />
                <label class="form-check-label" for="rep_type_full">Liquidar toda a conta</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="repayment_type" id="rep_type_partial" value="partial" checked />
                <label class="form-check-label" for="rep_type_partial">Pagamento parcial</label>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Conta da Empresa que recebe *</label>
              <div class="input-group input-group-outline">
                <select class="form-select" name="company_account" id="id_rep_company_account">
                  <option value="">— Seleccione —</option>
                  {% for ca in company_accounts %}
                    <option value="{{ ca.id }}">{{ ca.name }} ({{ ca.account_type.get_category_display }}) - {{ ca.account_identifier }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Data do Pagamento *</label>
              <div class="input-group input-group-outline">
                <input type="date" class="form-control" name="payment_date" id="id_rep_payment_date" />
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Valor a Pagar (MT) *</label>
              <div class="input-group input-group-outline">
                <input type="number" step="0.01" class="form-control" name="amount" id="id_rep_amount" />
              </div>
              <small class="text-muted" id="repaymentAmountHint">O valor será aplicado primeiro aos juros em falta deste ciclo e depois à amortização de principal.</small>
            </div>

            <div class="mb-3">
              <label class="form-label">Método</label>
              <div class="input-group input-group-outline">
                <select class="form-select" name="method" id="id_rep_method">
                  <option value="cash">Cash</option>
                  <option value="bank">Conta bancária</option>
                  <option value="mobile">Carteira móvel</option>
                </select>
              </div>
            </div>

            <hr class="my-3" />

            <div class="mb-3">
              <label class="form-label">Comprovativo (opcional)</label>
              <div class="input-group input-group-outline">
                <input type="file" class="form-control" name="attachment" id="id_rep_attachment" />
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Notas (opcional)</label>
              <div class="input-group input-group-outline">
                <textarea class="form-control" rows="2" name="notes" id="id_rep_notes"></textarea>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn bg-gradient-dark">Confirmar Pagamento</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <!-- DataTables + Buttons -->
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const table = $('#loan-repayment-table').DataTable({
        pageLength: 25,
        lengthMenu: [
          [10, 25, 50, -1],
          [10, 25, 50, 'Todos']
        ],
        order: [[0, 'desc']],
        dom: 'lBfrtip',
        buttons: [
          { extend: 'copy', text: 'Copiar', className: 'btn btn-sm btn-outline-secondary' },
          { extend: 'csv', text: 'CSV', className: 'btn btn-sm btn-outline-primary' },
          { extend: 'excel', text: 'Excel', className: 'btn btn-sm btn-outline-success' },
          { extend: 'pdf', text: 'PDF', className: 'btn btn-sm btn-outline-danger' },
          { extend: 'print', text: 'Imprimir', className: 'btn btn-sm btn-outline-dark' }
        ],
        language: {
          url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/pt-PT.json'
        }
      })
    
      // data default = hoje
      const today = new Date()
      const yyyy = today.getFullYear()
      const mm = String(today.getMonth() + 1).padStart(2, '0')
      const dd = String(today.getDate()).padStart(2, '0')
      const todayStr = `${yyyy}-${mm}-${dd}`
      $('#id_rep_payment_date').val(todayStr)
    
      let currentOutstanding = 0
      let currentInterestRemaining = 0
      let currentRate = 0
      let currentDue = ''
    
      function updateInfoBox() {
        const principal = currentOutstanding
        const interestRemaining = currentInterestRemaining
        const rate = currentRate
        const totalDueNow = +(principal + interestRemaining).toFixed(2)
    
        const html = `
              <strong>Resumo deste ciclo:</strong><br>
              Principal em dívida: <strong>MT ${principal.toFixed(2)}</strong><br>
              Taxa de juro do período: <strong>${rate.toFixed(2)}%</strong><br>
              Juros em falta neste ciclo: <strong>MT ${interestRemaining.toFixed(2)}</strong><br>
              Saldo em dívida (principal + juros em falta): <strong>MT ${totalDueNow.toFixed(2)}</strong><br>
              ${currentDue ? `<span class="badge bg-secondary mt-1">Validade: ${currentDue}</span><br>` : ''}
              <small class="text-muted">
                - "Liquidar apenas juros": paga os juros em falta e renova a validade (novo ciclo).<br>
                - "Liquidar toda a conta": paga principal + juros em falta e encerra o empréstimo.<br>
                - "Pagamento parcial": paga juros em falta + parte do principal.
              </small>
            `
        $('#repaymentInfoBox').html(html)
      }
    
      function applyRepaymentTypeToAmount() {
        const type = $('input[name="repayment_type"]:checked').val()
        const amountField = $('#id_rep_amount')
        const hintField = $('#repaymentAmountHint')
    
        const principal = currentOutstanding
        const interestRemaining = currentInterestRemaining
        const totalDueNow = +(principal + interestRemaining).toFixed(2)
    
        if (type === 'interest_only') {
          amountField.val(interestRemaining.toFixed(2))
          amountField.prop('readonly', true)
          hintField.text(`Será liquidado apenas o valor de juros em falta neste ciclo (MT ${interestRemaining.toFixed(2)}). ` + `O principal mantém-se igual e a validade é renovada.`)
        } else if (type === 'full') {
          amountField.val(totalDueNow.toFixed(2))
          amountField.prop('readonly', true)
          hintField.text(`Será liquidado o valor total em dívida (principal + juros em falta: MT ${totalDueNow.toFixed(2)}). ` + `O empréstimo será encerrado.`)
        } else {
          // partial
          amountField.val('')
          amountField.prop('readonly', false)
          if (interestRemaining > 0) {
            hintField.text('O valor pago será aplicado primeiro aos juros em falta deste ciclo ' + ` (mínimo MT ${interestRemaining.toFixed(2)}) e depois à amortização de principal.`)
          } else {
            hintField.text('Não há juros em falta neste ciclo. O valor pago será aplicado integralmente à amortização do principal.')
          }
        }
      }
    
      // abrir modal
      $(document).on('click', '.btn-open-repayment-modal', function () {
        const tr = $(this).closest('tr')
        const loanId = tr.data('loan-id')
        const memberName = tr.data('member-name')
        const outstanding = parseFloat(tr.data('outstanding') || '0') || 0
        const interestRemaining = parseFloat(tr.data('interest-remaining') || '0') || 0
        const rate = parseFloat(tr.data('interest-rate') || '0') || 0
        const due = tr.data('cycle-due') || ''
    
        currentOutstanding = outstanding
        currentInterestRemaining = interestRemaining
        currentRate = rate
        currentDue = due
    
        $('#id_rep_loan_id').val(loanId)
        $('#id_rep_company_account').val('')
        $('#id_rep_payment_date').val(todayStr)
        $('#id_rep_amount').val('')
        $('#id_rep_method').val('cash')
        $('#id_rep_attachment').val('')
        $('#id_rep_notes').val('')
    
        // default = parcial
        $('#rep_type_partial').prop('checked', true)
    
        $('#repaymentModalLabel').text('Registar Reembolso · Loan #' + loanId)
        $('#repaymentModalSubtitle').text(memberName || '')
    
        updateInfoBox()
        applyRepaymentTypeToAmount()
    
        const modalEl = document.getElementById('repaymentModal')
        const bsModal = new bootstrap.Modal(modalEl)
        bsModal.show()
      })
    
      // mudar tipo de reembolso
      $(document).on('change', 'input[name="repayment_type"]', function () {
        applyRepaymentTypeToAmount()
      })
    
      // submeter pagamento
      $('#repaymentForm').on('submit', function (e) {
        e.preventDefault()
    
        const loanId = $('#id_rep_loan_id').val()
        const companyAccount = $('#id_rep_company_account').val()
        const paymentDate = $('#id_rep_payment_date').val()
        const amount = $('#id_rep_amount').val().trim()
        const repaymentType = $('input[name="repayment_type"]:checked').val()
    
        if (!companyAccount || !paymentDate || !amount) {
          Swal.fire('Validação', 'Preencha tipo de reembolso, conta, data e valor do pagamento.', 'warning')
          return
        }
    
        const formData = new FormData(this)
        formData.set('repayment_type', repaymentType)
    
        $.ajax({
          url: "{% url 'core:register_repayment' 0 %}".replace('/0/', '/' + loanId + '/'),
          type: 'POST',
          data: formData,
          processData: false,
          contentType: false,
          headers: { 'X-CSRFToken': '{{ csrf_token }}' },
          success: function (resp) {
            if (resp.success) {
              $('#repaymentModal').modal('hide')
              Swal.fire({
                icon: 'success',
                title: 'Pagamento registado',
                text: resp.message,
                timer: 2500,
                showConfirmButton: false
              }).then(() => window.location.reload())
            } else {
              Swal.fire('Erro', resp.message || 'Falha ao registar pagamento.', 'error')
            }
          },
          error: function (xhr) {
            let msg = 'Falha ao registar pagamento.'
            if (xhr.responseJSON && xhr.responseJSON.message) {
              msg = xhr.responseJSON.message
            }
            Swal.fire('Erro', msg, 'error')
          }
        })
      })
    })
  </script>
{% endblock %}
