{% extends 'layouts/sl_base.html' %}
{% load static %}

{% block content %}
  <div class="container-fluid py-2">
    <div class="row">
      <div class="col-12 col-xl-11 mx-auto">
        <div class="card my-4">
          <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
            <div class="shadow-dark border-radius-lg pt-4 pb-3" style="background-color:#064E3B;">
              <h6 class="text-white text-capitalize ps-3">Pagamentos de Leasing · Veículos</h6>
            </div>
          </div>

          <div class="card-body px-0 pb-2">
            <div class="p-4">
              <!-- KPI CARDS -->
              <div class="row mb-4">
                <div class="col-md-4 col-sm-6 mb-3">
                  <div class="card shadow-sm border-0 h-100">
                    <div class="card-body py-3">
                      <p class="text-sm text-muted mb-1">Total de pagamentos</p>
                      <h4 class="mb-0">{{ kpi_total_pagamentos }}</h4>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 col-sm-6 mb-3">
                  <div class="card shadow-sm border-0 h-100">
                    <div class="card-body py-3">
                      <p class="text-sm text-muted mb-1">Valor total recebido (MT)</p>
                      <h5 class="mb-0">{{ kpi_total_valor|floatformat:2 }}</h5>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 col-sm-6 mb-3">
                  <div class="card shadow-sm border-0 h-100">
                    <div class="card-body py-3">
                      <p class="text-sm text-muted mb-1">
                        Recebido no mês ({{ today|date:"m/Y" }})
                      </p>
                      <h5 class="mb-0 text-success">{{ kpi_total_mes|floatformat:2 }}</h5>
                    </div>
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <h6 class="mb-0">Histórico de Pagamentos de Leasing</h6>
                  <p class="text-sm text-muted mb-0">
                    Todos os pagamentos registados para contratos de leasing de veículos.
                  </p>
                </div>
                <div>
                  <button type="button" class="btn bg-gradient-dark btn-sm" id="btn-open-add-payment">
                    <i class="material-symbols-rounded me-1" style="font-size:18px;">add</i>
                    Registar pagamento
                  </button>
                </div>
              </div>

              <div class="table-responsive">
                <table id="vehicle-lease-payment-table" class="table table-bordered table-striped align-items-center mb-0" style="width:100%">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Contrato</th>
                      <th>Viatura</th>
                      <th>Motorista</th>
                      <th>Data</th>
                      <th>Valor (MT)</th>
                      <th>Método</th>
                      <th>Conta da empresa</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for p in payments %}
                      <tr>
                        <td>{{ p.id }}</td>
                        <td>#{{ p.contract.id }}</td>
                        <td>
                          {{ p.contract.leased_vehicle.plate_number }}
                          <br />
                          <small class="text-muted">
                            {{ p.contract.leased_vehicle.model|default:'—' }}
                          </small>
                        </td>
                        <td>
                          {{ p.driver.first_name }} {{ p.driver.last_name }}
                          <br />
                          <small class="text-muted">{{ p.driver.phone }}</small>
                        </td>
                        <td>{{ p.payment_date }}</td>
                        <td>{{ p.amount|floatformat:2 }}</td>
                        <td>
                          {% if p.method == 'cash' %}
                            Cash
                          {% elif p.method == 'bank_transfer' %}
                            Transferência bancária
                          {% elif p.method == 'mobile_wallet' %}
                            Carteira móvel
                          {% else %}
                            {{ p.method }}
                          {% endif %}
                        </td>
                        <td>
                          {{ p.company_account.name }}
                          <br />
                          <small class="text-muted">
                            {{ p.company_account.account_identifier }}
                          </small>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% include 'includes/sl_footer.html' %}
  </div>

  <!-- MODAL: REGISTAR PAGAMENTO DE LEASING -->
  <div class="modal fade" id="addPaymentModal" tabindex="-1" aria-labelledby="addPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="addPaymentForm">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="addPaymentModalLabel">Registar Pagamento de Leasing</h5>
            <button type="button" class="btn-close text-dark" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Contrato *</label>
              <div class="input-group input-group-outline">
                <select class="form-select" name="contract" id="id_contract">
                  <option value="">— Seleccione —</option>
                  {% for c in active_contracts %}
                    <option value="{{ c.id }}" data-weekly-rent="{{ c.weekly_rent|floatformat:2 }}">
                      #{{ c.id }} · {{ c.leased_vehicle.plate_number }} · {{ c.driver.first_name }} {{ c.driver.last_name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <small class="text-muted" id="contract-weekly-rent-hint"></small>
            </div>

            <div class="mb-3">
              <label class="form-label">Conta da Empresa *</label>
              <div class="input-group input-group-outline">
                <select class="form-select" name="company_account" id="id_company_account">
                  <option value="">— Seleccione —</option>
                  {% for ca in company_accounts %}
                    <option value="{{ ca.id }}">{{ ca.name }} - {{ ca.account_identifier }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Data de pagamento *</label>
              <div class="input-group input-group-outline">
                <input type="date" class="form-control" name="payment_date" id="id_payment_date"
                       value="{{ today|date:'Y-m-d' }}" />
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Valor (MT) *</label>
              <div class="input-group input-group-outline">
                <input type="number" step="0.01" class="form-control" name="amount" id="id_amount" />
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Método</label>
              <div class="input-group input-group-outline">
                <select class="form-select" name="method" id="id_method">
                  <option value="cash">Cash</option>
                  <option value="bank_transfer">Transferência bancária</option>
                  <option value="mobile_wallet">Carteira móvel</option>
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Notas (opcional)</label>
              <div class="input-group input-group-outline">
                <textarea class="form-control" rows="2" name="notes" id="id_notes"></textarea>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn bg-gradient-dark">Registar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <!-- DataTables + Buttons + SweetAlert -->
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      $('#vehicle-lease-payment-table').DataTable({
        pageLength: 25,
        lengthMenu: [
          [10, 25, 50, -1],
          [10, 25, 50, 'Todos']
        ],
        order: [[4, 'desc'], [0, 'desc']], // ordena por data e depois por ID
        dom: 'lBfrtip',
        buttons: [
          { extend: 'copy', text: 'Copiar', className: 'btn btn-sm btn-outline-secondary' },
          { extend: 'csv', text: 'CSV', className: 'btn btn-sm btn-outline-primary' },
          { extend: 'excel', text: 'Excel', className: 'btn btn-sm btn-outline-success' },
          { extend: 'pdf', text: 'PDF', className: 'btn btn-sm btn-outline-danger' },
          { extend: 'print', text: 'Imprimir', className: 'btn btn-sm btn-outline-dark' }
        ],
        language: {
          url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/pt-PT.json'
        }
      })

      const paymentModalEl = document.getElementById('addPaymentModal')
      const paymentModal = new bootstrap.Modal(paymentModalEl)

      // abrir modal
      document.getElementById('btn-open-add-payment').addEventListener('click', function () {
        document.getElementById('addPaymentForm').reset()
        document.getElementById('contract-weekly-rent-hint').innerText = ''
        const todayStr = "{{ today|date:'Y-m-d'|default:None }}"
        if (todayStr) {
          document.getElementById('id_payment_date').value = todayStr
        }
        paymentModal.show()
      })

      // quando escolhe contrato, mostrar renda semanal padrão
      $('#id_contract').on('change', function () {
        const opt = this.selectedOptions[0]
        if (!opt) {
          $('#contract-weekly-rent-hint').text('')
          return
        }
        const weeklyRent = opt.getAttribute('data-weekly-rent')
        if (weeklyRent) {
          $('#contract-weekly-rent-hint').text('Renda semanal padrão deste contrato: MT ' + weeklyRent)
          const amountInput = document.getElementById('id_amount')
          if (amountInput.value === '') {
            amountInput.value = weeklyRent
          }
        } else {
          $('#contract-weekly-rent-hint').text('')
        }
      })

      // submit form via AJAX
      $('#addPaymentForm').on('submit', function (e) {
        e.preventDefault()

        const contract = $('#id_contract').val()
        const companyAcc = $('#id_company_account').val()
        const paymentDate = $('#id_payment_date').val()
        const amount = $('#id_amount').val().trim()

        if (!contract || !companyAcc || !paymentDate || !amount) {
          Swal.fire('Validação', 'Preencha todos os campos obrigatórios.', 'warning')
          return
        }

        const formData = $(this).serialize()

        $.ajax({
          url: "{% url 'core:create_vehicle_lease_payment' %}",
          type: 'POST',
          data: formData,
          headers: { 'X-CSRFToken': '{{ csrf_token }}' },
          success: function (resp) {
            if (resp.success) {
              paymentModal.hide()
              Swal.fire({
                icon: 'success',
                title: 'Pagamento registado',
                text: resp.message,
                timer: 2200,
                showConfirmButton: false
              }).then(() => window.location.reload())
            } else {
              Swal.fire('Erro', resp.message || 'Falha ao registar pagamento.', 'error')
            }
          },
          error: function (xhr) {
            Swal.fire('Erro', xhr.responseJSON?.message || 'Falha ao registar pagamento.', 'error')
          }
        })
      })
    })
  </script>
{% endblock %}
