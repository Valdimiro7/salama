{% extends "layouts/sl_base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid py-2">
  <!-- HEADER / HERO -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 px-2 px-md-0">
        <div>
          <h3 class="mb-1 h4 fw-bold">
            Salama · Microcrédito · Dashboard
          </h3>
          <p class="mb-0 text-sm text-muted">
            Visão geral da carteira de empréstimos, reembolsos, leasing Tuk-Tuk e fluxo de caixa.
          </p>
        </div>
        <div class="d-flex align-items-center gap-2">
          <select class="form-select form-select-sm" style="max-width: 180px;">
            <option>Últimos 30 dias</option>
            <option>Este mês</option>
            <option>Últimos 3 meses</option>
            <option>Desde o início do ano</option>
          </select>
          <a href="{% url 'core:new_loan' %}" class="btn btn-sm bg-gradient-dark">
            <i class="material-symbols-rounded me-1" style="font-size:18px;">add_circle</i>
            Novo Empréstimo
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- KPI CARDS -->
  <div class="row mb-4">
    <!-- Carteira total -->
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body py-3 px-3 d-flex flex-column">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <p class="text-xs text-muted mb-0 text-uppercase">Carteira total (MT)</p>
            <span class="icon icon-xs icon-shape bg-gradient-dark text-center border-radius-md">
              <i class="material-symbols-rounded text-white" style="font-size:18px;">account_balance</i>
            </span>
          </div>
          <h5 class="mb-1">
            {{ kpi_portfolio_total|default:0|floatformat:2 }}
          </h5>
          <span class="text-xs text-success">
            {{ kpi_portfolio_change_label|default:"+0% vs período anterior" }}
          </span>
        </div>
      </div>
    </div>

    <!-- Principal em dívida -->
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body py-3 px-3 d-flex flex-column">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <p class="text-xs text-muted mb-0 text-uppercase">Principal em dívida</p>
            <span class="icon icon-xs icon-shape bg-gradient-primary text-center border-radius-md">
              <i class="material-symbols-rounded text-white" style="font-size:18px;">request_quote</i>
            </span>
          </div>
          <h5 class="mb-1">
            {{ kpi_outstanding_principal|default:0|floatformat:2 }}
          </h5>
          <span class="text-xs text-muted">
            {{ kpi_outstanding_loans_count|default:0 }} empréstimos activos
          </span>
        </div>
      </div>
    </div>

    <!-- Juros a receber -->
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body py-3 px-3 d-flex flex-column">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <p class="text-xs text-muted mb-0 text-uppercase">Juros a receber</p>
            <span class="icon icon-xs icon-shape bg-gradient-success text-center border-radius-md">
              <i class="material-symbols-rounded text-white" style="font-size:18px;">percent</i>
            </span>
          </div>
          <h5 class="mb-1">
            {{ kpi_interest_to_receive|default:0|floatformat:2 }}
          </h5>
          <span class="text-xs text-muted">
            Inclui juros previstos em empréstimos activos.
          </span>
        </div>
      </div>
    </div>

    <!-- Reembolsos hoje -->
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body py-3 px-3 d-flex flex-column">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <p class="text-xs text-muted mb-0 text-uppercase">Reembolsos hoje (MT)</p>
            <span class="icon icon-xs icon-shape bg-gradient-info text-center border-radius-md">
              <i class="material-symbols-rounded text-white" style="font-size:18px;">download</i>
            </span>
          </div>
          <h5 class="mb-1">
            {{ kpi_today_repayments|default:0|floatformat:2 }}
          </h5>
          <span class="text-xs text-muted">
            {{ kpi_today_repayments_count|default:0 }} pagamentos registados.
          </span>
        </div>
      </div>
    </div>

    <!-- Leasing Tuk-Tuk activos -->
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body py-3 px-3 d-flex flex-column">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <p class="text-xs text-muted mb-0 text-uppercase">Leasing Tuk-Tuk activos</p>
            <span class="icon icon-xs icon-shape bg-gradient-warning text-center border-radius-md">
              <i class="material-symbols-rounded text-white" style="font-size:18px;">two_wheeler</i>
            </span>
          </div>
          <h5 class="mb-1">
            {{ kpi_tuktuk_active_contracts|default:0 }}
          </h5>
          <span class="text-xs text-muted">
            {{ kpi_tuktuk_month_income|default:0|floatformat:2 }} MT recebidos este mês.
          </span>
        </div>
      </div>
    </div>

    <!-- Saldo total contas empresa -->
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body py-3 px-3 d-flex flex-column">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <p class="text-xs text-muted mb-0 text-uppercase">Saldo contas empresa</p>
            <span class="icon icon-xs icon-shape bg-gradient-secondary text-center border-radius-md">
              <i class="material-symbols-rounded text-white" style="font-size:18px;">account_balance_wallet</i>
            </span>
          </div>
          <h5 class="mb-1">
            {{ kpi_company_accounts_balance|default:0|floatformat:2 }}
          </h5>
          <span class="text-xs text-muted">
            Soma de todas as contas activas da empresa.
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- GRÁFICOS PRINCIPAIS -->
  <div class="row mb-4">
    <!-- Linha: Desembolsos vs Reembolsos -->
    <div class="col-xl-6 col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header pb-0 d-flex justify-content-between align-items-start">
          <div>
            <h6 class="mb-1">Fluxo de Caixa · Empréstimos</h6>
            <p class="text-xs text-muted mb-0">Desembolsos vs Reembolsos por mês</p>
          </div>
        </div>
        <div class="card-body pt-2">
          <div style="height:260px;">
            <canvas id="chart-loan-cashflow" class="chart-canvas" height="260"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Doughnut: carteira por status -->
    <div class="col-xl-3 col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header pb-0">
          <h6 class="mb-1">Carteira por status</h6>
          <p class="text-xs text-muted mb-0">Distribuição de empréstimos</p>
        </div>
        <div class="card-body pt-3">
          <div style="height:230px;">
            <canvas id="chart-loan-status" class="chart-canvas" height="230"></canvas>
          </div>
          <div class="mt-3">
            <ul class="list-unstyled mb-0 text-xs">
              <li class="d-flex justify-content-between mb-1">
                <span>Activos</span>
                <strong>{{ kpi_status_active_count|default:0 }}</strong>
              </li>
              <li class="d-flex justify-content-between mb-1">
                <span>Pendentes</span>
                <strong>{{ kpi_status_pending_count|default:0 }}</strong>
              </li>
              <li class="d-flex justify-content-between mb-1">
                <span>Fechados</span>
                <strong>{{ kpi_status_closed_count|default:0 }}</strong>
              </li>
              <li class="d-flex justify-content-between">
                <span>Cancelados</span>
                <strong>{{ kpi_status_cancelled_count|default:0 }}</strong>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Barras: Microcrédito vs Leasing -->
    <div class="col-xl-3 col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header pb-0">
          <h6 class="mb-1">Microcrédito vs Leasing</h6>
          <p class="text-xs text-muted mb-0">Montantes recebidos (últimos 30 dias)</p>
        </div>
        <div class="card-body pt-3">
          <div style="height:230px;">
            <canvas id="chart-mc-vs-leasing" class="chart-canvas" height="230"></canvas>
          </div>
          <div class="mt-3 text-xs">
            <p class="mb-1">
              <span class="badge bg-dark me-1">&nbsp;</span> Microcrédito:
              <strong>{{ kpi_mc_income_30d|default:0|floatformat:2 }} MT</strong>
            </p>
            <p class="mb-0">
              <span class="badge bg-secondary me-1">&nbsp;</span> Leasing Tuk-Tuk:
              <strong>{{ kpi_tuktuk_income_30d|default:0|floatformat:2 }} MT</strong>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TABELAS: Empréstimos & Reembolsos recentes -->
  <div class="row mb-4">
    <!-- Empréstimos recentes -->
    <div class="col-xl-6 mb-4">
      <div class="card h-100">
        <div class="card-header pb-0 d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-1">Empréstimos recentes</h6>
            <p class="text-xs text-muted mb-0">Últimos pedidos registados</p>
          </div>
          <a href="{% url 'core:loan_list_all' %}" class="text-xs text-primary text-decoration-none">
            Ver todos
          </a>
        </div>
        <div class="card-body px-0 pb-0">
          <div class="table-responsive">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th class="text-xs text-secondary text-uppercase fw-bold ps-3">ID</th>
                  <th class="text-xs text-secondary text-uppercase fw-bold">Cliente</th>
                  <th class="text-xs text-secondary text-uppercase fw-bold text-end">Valor (MT)</th>
                  <th class="text-xs text-secondary text-uppercase fw-bold text-center">Status</th>
                  <th class="text-xs text-secondary text-uppercase fw-bold text-end pe-3">Criado em</th>
                </tr>
              </thead>
              <tbody>
                {% for loan in recent_loans %}
                  <tr>
                    <td class="ps-3 text-sm">#{{ loan.id }}</td>
                    <td class="text-sm">
                      {{ loan.member.first_name }} {{ loan.member.last_name }}
                      <br>
                      <span class="text-xs text-muted">
                        {{ loan.member.phone }}
                      </span>
                    </td>
                    <td class="text-sm text-end">
                      {{ loan.principal_amount|floatformat:2 }}
                    </td>
                    <td class="text-sm text-center">
                      {% if loan.status == "pending" %}
                        <span class="badge bg-warning text-dark text-xxs">Pendente</span>
                      {% elif loan.status == "approved" %}
                        <span class="badge bg-info text-white text-xxs">Aprovado</span>
                      {% elif loan.status == "disbursed" %}
                        <span class="badge bg-success text-white text-xxs">Desembolsado</span>
                      {% elif loan.status == "closed" %}
                        <span class="badge bg-secondary text-white text-xxs">Fechado</span>
                      {% elif loan.status == "cancelled" %}
                        <span class="badge bg-dark text-white text-xxs">Cancelado</span>
                      {% else %}
                        <span class="badge bg-light text-dark text-xxs">{{ loan.get_status_display }}</span>
                      {% endif %}
                    </td>
                    <td class="text-xs text-muted text-end pe-3">
                      {{ loan.created_at|date:"d/m/Y H:i" }}
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="5" class="text-center text-sm text-muted py-3">
                      Nenhum empréstimo recente encontrado.
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Reembolsos & Leasing recentes -->
    <div class="col-xl-6 mb-4">
      <div class="card h-100">
        <div class="card-header pb-0">
          <h6 class="mb-1">Entradas recentes</h6>
          <p class="text-xs text-muted mb-0">Reembolsos de empréstimos e leasing Tuk-Tuk</p>
        </div>
        <div class="card-body px-0 pb-0">
          <div class="table-responsive">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th class="text-xs text-secondary text-uppercase fw-bold ps-3">Tipo</th>
                  <th class="text-xs text-secondary text-uppercase fw-bold">Origem</th>
                  <th class="text-xs text-secondary text-uppercase fw-bold text-end">Valor (MT)</th>
                  <th class="text-xs text-secondary text-uppercase fw-bold text-end pe-3">Data</th>
                </tr>
              </thead>
              <tbody>
                {% for item in recent_cash_in %}
                  <tr>
                    <td class="ps-3 text-xs">
                      {% if item.source_type == "loan_repayment" %}
                        <span class="badge bg-success text-xxs">Reembolso</span>
                      {% elif item.source_type == "tuktuk_lease_payment" %}
                        <span class="badge bg-dark text-xxs">Leasing Tuk-Tuk</span>
                      {% else %}
                        <span class="badge bg-secondary text-xxs">{{ item.source_type|default:"Outro" }}</span>
                      {% endif %}
                    </td>
                    <td class="text-sm">
                      {{ item.label|default:"—" }}
                    </td>
                    <td class="text-sm text-end">
                      {{ item.amount|floatformat:2 }}
                    </td>
                    <td class="text-xs text-muted text-end pe-3">
                      {{ item.tx_date|date:"d/m/Y" }}
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="4" class="text-center text-sm text-muted py-3">
                      Nenhuma transacção recente encontrada.
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PRÓXIMAS PRESTAÇÕES / RISCO & RESUMO TUK-TUK -->
  <div class="row mb-4">
    <!-- Próximas prestações -->
    <div class="col-xl-5 mb-4">
      <div class="card h-100">
        <div class="card-header pb-0">
          <h6 class="mb-1">Próximos vencimentos</h6>
          <p class="text-xs text-muted mb-0">1ª prestação / validade de empréstimos a expirar</p>
        </div>
        <div class="card-body px-0 pb-0">
          <div class="table-responsive">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th class="text-xs text-secondary text-uppercase fw-bold ps-3">Empréstimo</th>
                  <th class="text-xs text-secondary text-uppercase fw-bold">Cliente</th>
                  <th class="text-xs text-secondary text-uppercase fw-bold text-center">Data</th>
                  <th class="text-xs text-secondary text-uppercase fw-bold text-center pe-3">Dias</th>
                </tr>
              </thead>
              <tbody>
                {% for item in upcoming_due_loans %}
                  <tr>
                    <td class="ps-3 text-sm">#{{ item.id }}</td>
                    <td class="text-sm">
                      {{ item.member.first_name }} {{ item.member.last_name }}
                    </td>
                    <td class="text-xs text-center">
                      {{ item.next_due_date|date:"d/m/Y" }}
                    </td>
                    <td class="text-xs text-center pe-3">
                      {% if item.days_to_due < 0 %}
                        <span class="badge bg-danger text-xxs">
                          {{ item.days_to_due }} dias
                        </span>
                      {% elif item.days_to_due <= 3 %}
                        <span class="badge bg-warning text-dark text-xxs">
                          {{ item.days_to_due }} dias
                        </span>
                      {% else %}
                        <span class="badge bg-success text-xxs">
                          {{ item.days_to_due }} dias
                        </span>
                      {% endif %}
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="4" class="text-center text-sm text-muted py-3">
                      Nenhum vencimento próximo.
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Resumo Tuk-Tuk -->
    <div class="col-xl-7 mb-4">
      <div class="card h-100">
        <div class="card-header pb-0 d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-1">Resumo Leasing · Tuk-Tuk</h6>
            <p class="text-xs text-muted mb-0">Contratos, pagamentos e saldos em aberto</p>
          </div>
          <a href="{% url 'core:tuktuk_lease_contract_list' %}" class="text-xs text-primary text-decoration-none">
            Gerir contratos
          </a>
        </div>
        <div class="card-body px-0 pb-0">
          <div class="table-responsive">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th class="text-xs text-secondary text-uppercase fw-bold ps-3">Tuk-Tuk</th>
                  <th class="text-xs text-secondary text-uppercase fw-bold">Motorista</th>
                  <th class="text-xs text-secondary text-uppercase fw-bold text-end">Semanal (MT)</th>
                  <th class="text-xs text-secondary text-uppercase fw-bold text-end">Recebido (MT)</th>
                  <th class="text-xs text-secondary text-uppercase fw-bold text-end pe-3">Saldo (MT)</th>
                </tr>
              </thead>
              <tbody>
                {% for c in tuktuk_dashboard_contracts %}
                  <tr>
                    <td class="ps-3 text-sm">
                      {{ c.tuktuk_label }}
                    </td>
                    <td class="text-sm">
                      {{ c.driver_name }}
                    </td>
                    <td class="text-sm text-end">
                      {{ c.weekly_amount|floatformat:2 }}
                    </td>
                    <td class="text-sm text-end">
                      {{ c.received_amount|floatformat:2 }}
                    </td>
                    <td class="text-sm text-end pe-3">
                      {% if c.balance > 0 %}
                        <span class="text-danger">{{ c.balance|floatformat:2 }}</span>
                      {% else %}
                        <span class="text-success">{{ c.balance|floatformat:2 }}</span>
                      {% endif %}
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="5" class="text-center text-sm text-muted py-3">
                      Nenhum contrato de leasing registado.
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% include "includes/sl_footer.html" %}
</div>
{% endblock content %}

{% block extra_js %}
<script src="{% static 'assets/js/plugins/chartjs.min.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // ==========================
    // Dados dos gráficos vindos do contexto (view)
    // ==========================
    const loanCashflowLabels = {{ chart_loan_cashflow_labels|default:"[]"|safe }};
    const loanCashflowDisb   = {{ chart_loan_cashflow_disbursed|default:"[]"|safe }};
    const loanCashflowRepay  = {{ chart_loan_cashflow_repaid|default:"[]"|safe }};

    const loanStatusLabels = {{ chart_loan_status_labels|default:"[]"|safe }};
    const loanStatusValues = {{ chart_loan_status_values|default:"[]"|safe }};

    const mcVsLeasingLabels = {{ chart_mc_vs_leasing_labels|default:"[]"|safe }};
    const mcVsLeasingMC     = {{ chart_mc_vs_leasing_mc_values|default:"[]"|safe }};
    const mcVsLeasingLeas   = {{ chart_mc_vs_leasing_leasing_values|default:"[]"|safe }};

    // ==========================
    // Chart 1: Linha – Desembolsos vs Reembolsos
    // ==========================
    const ctx1 = document.getElementById('chart-loan-cashflow');
    if (ctx1) {
      new Chart(ctx1.getContext('2d'), {
        type: 'line',
        data: {
          labels: loanCashflowLabels,
          datasets: [
            {
              label: 'Desembolsos',
              data: loanCashflowDisb,
              tension: 0.3,
              borderWidth: 2,
              borderColor: '#ef5350',
              backgroundColor: 'rgba(239, 83, 80, 0.12)',
              pointRadius: 3,
              pointBackgroundColor: '#ef5350',
              fill: true
            },
            {
              label: 'Reembolsos',
              data: loanCashflowRepay,
              tension: 0.3,
              borderWidth: 2,
              borderColor: '#43a047',
              backgroundColor: 'rgba(67, 160, 71, 0.12)',
              pointRadius: 3,
              pointBackgroundColor: '#43a047',
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true },
          },
          interaction: {
            intersect: false,
            mode: 'index',
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                drawBorder: false,
                color: '#e5e5e5',
                borderDash: [4, 4],
              },
              ticks: {
                color: '#737373',
                font: { size: 11 }
              }
            },
            x: {
              grid: { display: false },
              ticks: {
                color: '#737373',
                font: { size: 11 }
              }
            }
          }
        }
      });
    }

    // ==========================
    // Chart 2: Doughnut – status da carteira
    // ==========================
    const ctx2 = document.getElementById('chart-loan-status');
    if (ctx2) {
      new Chart(ctx2.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: loanStatusLabels,
          datasets: [{
            data: loanStatusValues,
            backgroundColor: ['#43a047', '#ffb300', '#9e9e9e', '#424242'],
            hoverOffset: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: { boxWidth: 10, font: { size: 10 } }
            }
          },
          cutout: '60%'
        }
      });
    }

    // ==========================
    // Chart 3: Barras – Microcrédito vs Leasing
    // ==========================
    const ctx3 = document.getElementById('chart-mc-vs-leasing');
    if (ctx3) {
      new Chart(ctx3.getContext('2d'), {
        type: 'bar',
        data: {
          labels: mcVsLeasingLabels,
          datasets: [
            {
              label: 'Microcrédito',
              data: mcVsLeasingMC,
              backgroundColor: '#1e88e5',
              borderRadius: 4,
              maxBarThickness: 20
            },
            {
              label: 'Leasing Tuk-Tuk',
              data: mcVsLeasingLeas,
              backgroundColor: '#6d4c41',
              borderRadius: 4,
              maxBarThickness: 20
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                drawBorder: false,
                color: '#e5e5e5',
                borderDash: [4,4]
              },
              ticks: {
                color: '#737373',
                font: { size: 11 }
              }
            },
            x: {
              grid: { display: false },
              ticks: {
                color: '#737373',
                font: { size: 11 }
              }
            }
          }
        }
      });
    }
  });
</script>
{% endblock extra_js %}
